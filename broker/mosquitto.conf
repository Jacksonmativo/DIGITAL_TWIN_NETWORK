# ============================================================================
# Mosquitto MQTT Broker Configuration
# Digital Twin Network - MQTT Broker Settings
# ============================================================================
#
# This configuration file sets up the Mosquitto MQTT broker for the
# Digital Twin Network system with optimized settings for IoT devices.
#
# Configuration Sections:
# 1. General Settings
# 2. Network & Listeners
# 3. Security & Authentication
# 4. Persistence & Storage
# 5. Logging
# 6. Performance & Limits
# 7. Websockets (Optional)
# 8. Bridge Configuration (Optional)
#
# ============================================================================

# ============================================================================
# GENERAL SETTINGS
# ============================================================================

# Unique broker ID (useful for clustered deployments)
# broker_id digital_twin_broker_1

# User to run the broker as (Linux only)
# Uncomment and set to run as specific user
# user mosquitto

# Maximum number of client connections (0 = unlimited)
# Set to -1 to disable new connections
max_connections -1

# Maximum number of QoS 1 and 2 messages currently inflight
# per client (default: 20)
max_inflight_messages 20

# Maximum number of QoS 1 and 2 messages to hold in queue
# per client above inflight messages (default: 100)
max_queued_messages 1000

# Maximum QoS level the broker will accept (0, 1, or 2)
# Default: 2 (allows all QoS levels)
max_qos 2

# ============================================================================
# NETWORK & LISTENERS
# ============================================================================

# Default listener on port 1883 (MQTT)
# This is the standard MQTT port for unencrypted connections
listener 1883
protocol mqtt

# Bind address (default: all interfaces)
# Use 0.0.0.0 to listen on all IPv4 interfaces
# Use :: to listen on all IPv6 interfaces
# bind_address 0.0.0.0

# Maximum number of concurrent connections per listener
# max_connections -1

# ============================================================================
# SECURITY & AUTHENTICATION
# ============================================================================

# Allow anonymous connections
# Set to false in production and use password file or plugin
allow_anonymous true

# Password file for authentication
# Create with: mosquitto_passwd -c /etc/mosquitto/passwd username
# Uncomment to enable password authentication:
# password_file /etc/mosquitto/passwd

# Access Control List (ACL) file
# Defines topic-based permissions for users
# Uncomment to enable ACL:
# acl_file /etc/mosquitto/acl

# ============================================================================
# ACL EXAMPLES (Uncomment and customize)
# ============================================================================
#
# Create /etc/mosquitto/acl file with content like:
#
# # Admin user has full access
# user admin
# topic readwrite #
#
# # Device users can only publish to their own topics
# pattern read device/%u/#
# pattern write device/%u/#
#
# # Application users can read all device topics
# user app_user
# topic read device/#
# topic read twin/#
#
# ============================================================================

# ============================================================================
# TLS/SSL CONFIGURATION (Encrypted Connections)
# ============================================================================
#
# Uncomment and configure for secure MQTT connections (port 8883)
#
# listener 8883
# protocol mqtt
#
# # Path to PEM encoded CA certificate
# cafile /etc/mosquitto/certs/ca.crt
#
# # Path to PEM encoded server certificate
# certfile /etc/mosquitto/certs/server.crt
#
# # Path to PEM encoded server private key
# keyfile /etc/mosquitto/certs/server.key
#
# # Require clients to provide certificates
# require_certificate false
#
# # TLS version (tlsv1.2 or tlsv1.3)
# tls_version tlsv1.2
#
# ============================================================================

# ============================================================================
# PERSISTENCE & STORAGE
# ============================================================================

# Enable persistence (save in-memory database to disk)
# Recommended for production to survive restarts
persistence true

# Location of persistence database
persistence_location /var/lib/mosquitto/

# Filename for persistence database
persistence_file mosquitto.db

# Save persistent database to disk every N seconds if changes made
# 0 = save only on shutdown, 1800 = 30 minutes (default)
autosave_interval 300

# Save persistent database on clean shutdown only
# autosave_on_changes false

# Store QoS 1 and 2 messages to disk when persistence is enabled
# queue_qos0_messages false

# Retain messages in memory only (faster but lose on restart)
# retained_persistence true

# Maximum number of retained messages (0 = unlimited)
max_retained_messages 0

# ============================================================================
# LOGGING
# ============================================================================

# Log destinations (stdout, stderr, syslog, topic, file, dlt)
# Multiple destinations can be specified
log_dest stdout
log_dest file /var/log/mosquitto/mosquitto.log

# Log types to include
# Options: error, warning, notice, information, all, debug
# Multiple types can be specified
log_type error
log_type warning
log_type notice
log_type information

# Log connection messages
connection_messages true

# Log timestamp format
# If true, messages include timestamp
log_timestamp true

# Timestamp format (strftime format)
log_timestamp_format %Y-%m-%d %H:%M:%S

# ============================================================================
# PERFORMANCE & LIMITS
# ============================================================================

# Maximum packet size (bytes)
# Default: 0 (unlimited, protocol max is 256MB)
# Set lower for resource-constrained systems
message_size_limit 0

# Memory limit for outgoing message queue (bytes per client)
# 0 = unlimited
# memory_limit 0

# Maximum publish payload size (bytes)
# Default: 268435455 (256MB - 1)
max_packet_size 268435455

# Enable/disable Nagle's algorithm for TCP connections
# false = disable (lower latency, recommended for MQTT)
# true = enable (better throughput for large messages)
# Default: false
# set_tcp_nodelay false

# ============================================================================
# CLIENT SESSION SETTINGS
# ============================================================================

# Persistent client expiration time
# Time in seconds before a persistent client session expires
# when the client disconnects. 0 = never expire.
# Default: 0
persistent_client_expiration 0

# Client ID prefixes that are automatically assigned (for anonymous clients)
# auto_id_prefix auto-

# ============================================================================
# WEBSOCKETS SUPPORT (Optional)
# ============================================================================
#
# Enable WebSocket support for browser-based clients
# Requires Mosquitto compiled with WebSocket support
#
# listener 9001
# protocol websockets
#
# # WebSocket path (default: /)
# # http_dir /var/www/mosquitto
#
# # CORS settings for WebSocket
# # websockets_log_level 4
#
# ============================================================================

# ============================================================================
# MQTT V5 SPECIFIC SETTINGS
# ============================================================================

# Maximum topic alias value that clients can use
# 0 = disabled (default: 0)
max_topic_alias 10

# Server-assigned keepalive override
# 0 = use client's keepalive value (default)
# keepalive 60

# ============================================================================
# BRIDGE CONFIGURATION (Optional - for connecting multiple brokers)
# ============================================================================
#
# Bridge to connect this broker to another MQTT broker
# Useful for hierarchical or distributed deployments
#
# connection bridge_name
# address remote_broker:1883
# topic pattern in/out qos remote_topic local_topic
#
# Example: Bridge to cloud broker
# connection cloud_bridge
# address mqtt.example.com:1883
# topic device/# out 1 "" cloud/devices/
# topic command/# in 1 cloud/commands/ ""
# cleansession false
# try_private true
# username bridge_user
# password bridge_pass
#
# ============================================================================

# ============================================================================
# MONITORING & SYSTEM TOPICS
# ============================================================================

# Publish broker system information to topics
# $SYS topics provide statistics and status information

# Interval (seconds) for updating $SYS topics
# 0 = disable $SYS topics (default: 10)
sys_interval 10

# ============================================================================
# WILL MESSAGES (Last Will and Testament)
# ============================================================================

# No specific configuration needed here
# Clients configure their own Will messages on connection

# ============================================================================
# OPTIMIZATION FOR DIGITAL TWIN NETWORK
# ============================================================================

# Optimizations specific to IoT/Digital Twin workloads:

# 1. Increase queue size for high-throughput scenarios
max_queued_messages 1000

# 2. Faster autosave for data integrity
autosave_interval 300

# 3. Enable persistence for reliability
persistence true

# 4. Log important events only (reduce disk I/O)
# log_type error
# log_type warning
# log_type notice

# 5. Enable connection messages for monitoring
connection_messages true

# 6. Reasonable session expiration (1 day = 86400 seconds)
# persistent_client_expiration 86400

# ============================================================================
# RECOMMENDED PRODUCTION SETTINGS
# ============================================================================
#
# For production deployment, consider these changes:
#
# 1. DISABLE anonymous access:
#    allow_anonymous false
#    password_file /etc/mosquitto/passwd
#
# 2. ENABLE ACL for topic-level security:
#    acl_file /etc/mosquitto/acl
#
# 3. ENABLE TLS/SSL encryption:
#    listener 8883
#    cafile /path/to/ca.crt
#    certfile /path/to/server.crt
#    keyfile /path/to/server.key
#
# 4. SET resource limits:
#    max_connections 10000
#    max_inflight_messages 20
#    max_queued_messages 1000
#
# 5. CONFIGURE logging appropriately:
#    log_dest file /var/log/mosquitto/mosquitto.log
#    log_type error
#    log_type warning
#
# 6. ENABLE persistence:
#    persistence true
#    autosave_interval 300
#
# ============================================================================

# ============================================================================
# DEVELOPMENT/TESTING SETTINGS (Current Configuration)
# ============================================================================
#
# Current settings are optimized for development and testing:
# - Anonymous access enabled (no authentication required)
# - Unencrypted connections on port 1883
# - Verbose logging to stdout and file
# - Persistence enabled for data safety
# - All QoS levels supported
# - Reasonable queue and connection limits
#
# These settings allow easy testing but should NOT be used in production
# without proper security hardening (authentication, encryption, ACLs).
#
# ============================================================================

# ============================================================================
# USEFUL MOSQUITTO COMMANDS
# ============================================================================
#
# Start/Stop/Restart Mosquitto:
#   sudo systemctl start mosquitto
#   sudo systemctl stop mosquitto
#   sudo systemctl restart mosquitto
#
# Check Mosquitto status:
#   sudo systemctl status mosquitto
#
# Test configuration:
#   mosquitto -c /etc/mosquitto/mosquitto.conf -v
#
# Create password file:
#   mosquitto_passwd -c /etc/mosquitto/passwd username
#
# Add user to existing password file:
#   mosquitto_passwd /etc/mosquitto/passwd username
#
# Subscribe to test topic:
#   mosquitto_sub -h localhost -t "test/topic" -v
#
# Publish to test topic:
#   mosquitto_pub -h localhost -t "test/topic" -m "Hello MQTT"
#
# Subscribe to all topics (useful for debugging):
#   mosquitto_sub -h localhost -t "#" -v
#
# Monitor $SYS topics (broker statistics):
#   mosquitto_sub -h localhost -t '$SYS/#' -v
#
# ============================================================================

# ============================================================================
# TROUBLESHOOTING
# ============================================================================
#
# If broker fails to start, check:
#
# 1. Configuration syntax:
#    mosquitto -c /etc/mosquitto/mosquitto.conf -v
#
# 2. File permissions:
#    - Config file readable by mosquitto user
#    - Log directory writable by mosquitto user
#    - Persistence directory writable by mosquitto user
#
# 3. Port availability:
#    sudo netstat -tlnp | grep 1883
#    sudo lsof -i :1883
#
# 4. Firewall rules:
#    sudo ufw allow 1883/tcp
#    sudo firewall-cmd --add-port=1883/tcp --permanent
#
# 5. SELinux (if enabled):
#    Check SELinux logs: sudo ausearch -m avc -ts recent
#
# 6. Log files:
#    sudo tail -f /var/log/mosquitto/mosquitto.log
#    sudo journalctl -u mosquitto -f
#
# ============================================================================

# ============================================================================
# ADDITIONAL RESOURCES
# ============================================================================
#
# Official Mosquitto Documentation:
#   https://mosquitto.org/documentation/
#
# Configuration File Reference:
#   https://mosquitto.org/man/mosquitto-conf-5.html
#
# MQTT Protocol Specification:
#   https://mqtt.org/mqtt-specification/
#
# Security Best Practices:
#   https://mosquitto.org/documentation/authentication-methods/
#
# ============================================================================

# End of configuration file